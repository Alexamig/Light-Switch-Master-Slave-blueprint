blueprint:
  name: Light_Switch Master_Slave v5.0 FINAL STABLE
  description: >
      ‚úî Production-ready Master/Slave automation blueprint.
      
      ‚úî Status: FINAL STABLE (frozen architecture)
      
      –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π blueprint –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è `light` –∏ `switch`
      —Å –ø–æ–ª–Ω–æ–π fail-safe –∑–∞—â–∏—Ç–æ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç—á–∏–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –∏ —Ç–∞–π–º–µ—Ä–∞.
    
      <details>
      <summary>‚≠ê –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ)</summary>
  
        1Ô∏è‚É£ ‚è±Ô∏è  **–ó–ê–î–ï–†–ñ–ö–ò –ü–û –î–í–ò–ñ–ï–ù–ò–Æ:`
      
       ‚è≥ **–ó–∞–¥–µ—Ä–∂–∫–∞ –î–û –¥–≤–∏–∂–µ–Ω–∏—è:**
        ‚Ä¢ –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è.
        ‚Ä¢ –°–æ–±—ã—Ç–∏–µ `motion_on` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏
        ‚Ä¢ –¥–∞—Ç—á–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `on` –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ
        ‚Ä¢ –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
        ‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø—Ä–∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–∞—Ö.
      
       ‚è≥ **–ó–∞–¥–µ—Ä–∂–∫–∞ –ü–û–°–õ–ï –¥–≤–∏–∂–µ–Ω–∏—è:**
        ‚Ä¢ –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è.
        ‚Ä¢ –°–æ–±—ã—Ç–∏–µ `motion_off` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π,
        ‚Ä¢ –∏ —Ç–∞–π–º–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –µ—ë –æ–∫–æ–Ω—á–∞–Ω–∏—è.
        ‚Ä¢ –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–≤–µ—Ç—É –Ω–µ –≥–∞—Å–Ω—É—Ç—å –ø—Ä–∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è.
    
      2Ô∏è‚É£ Master:
        ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é, –µ—Å–ª–∏:
          ‚Äì **üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é** = –í–ö–õ (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ)
          ‚Äì **üåú –†–µ–∂–∏–º –ù–æ—á—å** –∞–∫—Ç–∏–≤–µ–Ω (–∏–ª–∏ **üîÜ –†–µ–∂–∏–º –î–µ–Ω—å/–ù–æ—á—å** –≤—ã–∫–ª—é—á–µ–Ω)
        ‚Ä¢ –ü—Ä–∏ –ø—Ä–æ–ø–∞–∂–µ –¥–≤–∏–∂–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä Master,
          –µ—Å–ª–∏ Master –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–æ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
        ‚Ä¢ –†—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ Master –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è
          –í–°–ï–ì–î–ê –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä Master.
        ‚Ä¢ –†—É—á–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ Master:
            ‚Äì –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä Master;
            ‚Äì –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã–∫–ª—é—á–∞–µ—Ç –≤—Å–µ Slave.
        ‚Ä¢ ‚ö° **–ê–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é:**
            ‚Äì Master –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            ‚Äì **Slave –≤–∫–ª—é—á–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¢–û–õ–¨–ö–û –µ—Å–ª–∏:**
              * –≤–∫–ª—é—á–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è üîÑ
              * –≤—Å–µ Slave –≤—ã–∫–ª—é—á–µ–Ω—ã
              * —Ä–∞–∑—Ä–µ—à—ë–Ω —Ä–µ–∂–∏–º Night/Day
              * **üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é** = –í–ö–õ
    
      3Ô∏è‚É£ Slave:
        ‚Ä¢ –¢–∞–π–º–µ—Ä Slave —è–≤–ª—è–µ—Ç—Å—è –≥—Ä—É–ø–ø–æ–≤—ã–º:
          –æ–¥–∏–Ω —Ç–∞–π–º–µ—Ä —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ Slave –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
        ‚Ä¢ –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ Slave (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
          –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç Master, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤—ã–∫–ª—é—á–µ–Ω.
        ‚Ä¢ –ü—Ä–∏ —Ä—É—á–Ω–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏ Slave –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è
          –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä Slave (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞).
        ‚Ä¢ –ü—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
            ‚Äì –≤–∫–ª—é—á–∞—é—Ç—Å—è **–≤—Å–µ** –æ—Å—Ç–∞–ª—å–Ω—ã–µ Slave, –∫—Ä–æ–º–µ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–≤—à–µ–≥–æ —Å–æ–±—ã—Ç–∏–µ
            ‚Äì —Ç–∞–π–º–µ—Ä Slave –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–π–º–µ—Ä Master)
        ‚Ä¢ –†—É—á–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ Slave:
            ‚Äì –Ω–µ –≤—ã–∫–ª—é—á–∞–µ—Ç Master;
            ‚Äì –µ—Å–ª–∏ Master –≤—ã–∫–ª—é—á–µ–Ω –∏ –≤—Å–µ Slave –≤—ã–∫–ª—é—á–µ–Ω—ã,
              –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.
        ‚Ä¢ –¢–∞–π–º–µ—Ä Slave —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è:
          –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è.
    
      4Ô∏è‚É£ –¢–∞–π–º–µ—Ä:
        ‚Ä¢ –¢–∞–π–º–µ—Ä—ã Master –∏ Slave –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ idle (–Ω–µ –∞–∫—Ç–∏–≤–Ω—ã).
        ‚Ä¢ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
        ‚Ä¢ –¢–∞–π–º–µ—Ä Master –≤—ã–∫–ª—é—á–∞–µ—Ç Master –∏ **–≤—Å–µ –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ Slave** (–ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –æ–±—â–µ–º —Ç–∞–π–º–µ—Ä–µ).
        ‚Ä¢ –¢–∞–π–º–µ—Ä Slave —è–≤–ª—è–µ—Ç—Å—è –æ–±—â–∏–º –¥–ª—è –≤—Å–µ—Ö Slave –∏ –≤—ã–∫–ª—é—á–∞–µ—Ç –í–°–ï –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ Slave –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
        ‚Ä¢ ‚ö†Ô∏è –†–∞–±–æ—Ç–∞—é—Ç –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥–Ω—è/–Ω–æ—á–∏!
    
      5Ô∏è‚É£ –î–µ–Ω—å / –ù–æ—á—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
       | –†–µ–∂–∏–º | –î–≤–∏–∂–µ–Ω–∏–µ | –ê–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
       |-------|---------|----------------|----------|
       | üåû –î–µ–Ω—å | –ï—Å—Ç—å | ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ | –°–≤–µ—Ç –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è |
       | üåû –î–µ–Ω—å | –ù–µ—Ç | ‚ùå –ó–∞–ø—Ä–µ—â–µ–Ω–æ | - |
       | üåú –ù–æ—á—å | –ï—Å—Ç—å | ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ | –°–≤–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç—Å—è |
       | üåú –ù–æ—á—å | –ù–µ—Ç | ‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–æ | - |
       
       **üîÑ –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞:**
       ‚Ä¢ –î–µ–Ω—å ‚Üí –ù–æ—á—å, –¥–≤–∏–∂–µ–Ω–∏–µ –µ—Å—Ç—å ‚Üí **—Å–≤–µ—Ç –í–ö–õ–Æ–ß–ê–ï–¢–°–Ø** ‚úÖ
       ‚Ä¢ –ù–æ—á—å ‚Üí –î–µ–Ω—å, –¥–≤–∏–∂–µ–Ω–∏–µ –µ—Å—Ç—å ‚Üí **—Å–≤–µ—Ç –í–´–ö–õ–Æ–ß–ê–ï–¢–°–Ø** ‚úÖ
       ‚Ä¢ –ù–æ—á—å ‚Üí –î–µ–Ω—å, –¥–≤–∏–∂–µ–Ω–∏—è –Ω–µ—Ç ‚Üí **—Å–≤–µ—Ç –í–´–ö–õ–Æ–ß–ê–ï–¢–°–Ø** ‚úÖ
    
       üîß –ü—Ä–∏–º–µ—Ä –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è night_sensor:
       ```
       template:
         - binary_sensor:
             - name: "Night Always"
               unique_id: night_always
               state: "{{ false }}"
               availability: "{{ true }}"
       ```
       ‚Ä¢ `state: "{{ false }}"` - –í—Å–µ–≥–¥–∞ –ù–æ—á—å (OFF) ‚úÖ –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
       ‚Ä¢ `state: "{{ true }}"`  - –í—Å–µ–≥–¥–∞ –î–µ–Ω—å (ON) ‚ùå –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ
  
      6Ô∏è‚É£ Fail-safe (–∞–≤–∞—Ä–∏–π–Ω–∞—è –∑–∞—â–∏—Ç–∞):
        ‚Ä¢ –ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è `unavailable` –∏–ª–∏ `unknown`,
          –∏ –ø—Ä–∏ —ç—Ç–æ–º Master –∏–ª–∏ –ª—é–±–æ–π Slave –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∫–ª—é—á—ë–Ω,
          –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–∞–π–º–µ—Ä.
        ‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç.
     
      7Ô∏è‚É£ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
        ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—é–±–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ Slave-—É—Å—Ç—Ä–æ–π—Å—Ç–≤.
        ‚Ä¢ Slave –º–æ–≥—É—Ç –±—ã—Ç—å —Å–º–µ—à–∞–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ (`light` –∏ `switch`).
        ‚Ä¢ **–î–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏:** –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è (`debounce_no_motion`) –∏ –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è (`debounce_after_motion`).
        ‚Ä¢ –í—Å–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ü–µ–ª–µ–≤—ã—Ö entity.
        
      8Ô∏è‚É£ **üí° –ì–ò–ë–ö–û–°–¢–¨ –¢–ê–ô–ú–ï–†–û–í:**
        ‚Ä¢ –û–¥–∏–Ω —Ç–∞–π–º–µ—Ä –¥–ª—è Master –∏ Slave ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –û–î–ò–ù –ò –¢–û–¢ –ñ–ï `timer` helper –≤ –æ–±–æ–∏—Ö –ø–æ–ª—è—Ö!
        ‚Ä¢ ‚úÖ Master —Ç–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–∏—Ç Master –∏ Slave (–ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
        ‚Ä¢ ‚úÖ Slave —Ç–∞–π–º–µ—Ä –≤—ã–∫–ª—é—á–∏—Ç —Ç–æ–ª—å–∫–æ Slave  
        ‚Ä¢ ‚ö° –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏!
        ‚Ä¢ üîß –ü—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏—Ç–µ –æ–¥–∏–Ω entity –≤:
          ‚Äì `‚è±Ô∏è –¢–∞–π–º–µ—Ä Master`
          ‚Äì `‚è≤Ô∏è –¢–∞–π–º–µ—Ä Slave`
  
      9Ô∏è‚É£ **üîå –£–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ñ–ò–ú–ê–ú–ò:**
      
        **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ `üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é` –∏ `üîÜ –†–µ–∂–∏–º –î–µ–Ω—å/–ù–æ—á—å`:**
      
        | üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é | üîÜ –†–µ–∂–∏–º –î–µ–Ω—å/–ù–æ—á—å | –î–≤–∏–∂–µ–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
        |----------------|-------------------|----------|-----------|
        | ‚úÖ –í–ö–õ | ‚ùå –í–´–ö–õ | –ï—Å—Ç—å | ‚úÖ –°–≤–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ |
        | ‚úÖ –í–ö–õ | ‚ùå –í–´–ö–õ | –ù–µ—Ç | ‚ùå –¢–∞–π–º–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è |
        | ‚úÖ –í–ö–õ | ‚úÖ –í–ö–õ (–î–µ–Ω—å) | –ï—Å—Ç—å | ‚ùå –°–≤–µ—Ç –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è |
        | ‚úÖ –í–ö–õ | ‚úÖ –í–ö–õ (–ù–æ—á—å) | –ï—Å—Ç—å | ‚úÖ –°–≤–µ—Ç –≤–∫–ª—é—á–∞–µ—Ç—Å—è |
        | ‚ùå –í–´–ö–õ | –õ—é–±–æ–π | –ï—Å—Ç—å | ‚ùå –°–≤–µ—Ç –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è |
        | ‚ùå –í–´–ö–õ | –õ—é–±–æ–π | –ù–µ—Ç | ‚ùå –¢–æ–ª—å–∫–æ —Ç–∞–π–º–µ—Ä—ã –æ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª |
      
        **–í–∞–∂–Ω–æ:** 
        ‚Ä¢ `üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é = –í–´–ö–õ` –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É,
          –Ω–æ —Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç–∞–π–º–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –æ–±—ã—á–Ω–æ
        ‚Ä¢ –ü—Ä–∏ —Å–º–µ–Ω–µ –î–µ–Ω—å/–ù–æ—á—å —Å–≤–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º
          (–¥–∞–∂–µ –µ—Å–ª–∏ `üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é = –í–´–ö–õ`)
  
      üîü **üîï –ò–ì–ù–û–†–ò–†–û–í–ê–ù–ò–ï –í–†–ï–ú–ï–ù–ò –°–£–¢–û–ö –î–õ–Ø SLAVE:**
    
        –§—É–Ω–∫—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º Slave —Ä–∞–±–æ—Ç–∞—Ç—å **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ** –æ—Ç –¥–Ω—è/–Ω–æ—á–∏.
    
        | –°–∏—Ç—É–∞—Ü–∏—è | üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è | üîï –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
        |----------|-----------------|------------------|-----------|
        | Slave –≤ —Å–ø–∏—Å–∫–µ | ‚ùå –í–´–ö–õ | ‚úÖ –í —Å–ø–∏—Å–∫–µ | **–†–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞** |
        | Slave –ù–ï –≤ —Å–ø–∏—Å–∫–µ | ‚ùå –í–´–ö–õ | ‚ùå –í–Ω–µ —Å–ø–∏—Å–∫–∞ | –°–ª–µ–¥—É–µ—Ç –¥–µ–Ω—å/–Ω–æ—á—å |
        | –õ—é–±–æ–π Slave | ‚úÖ –í–ö–õ | –õ—é–±–æ–µ | ‚ùå **–ù–ï –†–ê–ë–û–¢–ê–ï–¢** (–≤—Å–µ –∫–∞–∫ –≥—Ä—É–ø–ø–∞) |
    
        **üìå –í–ê–ñ–ù–û:** –û–ø—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ **üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è = –í–´–ö–õ**
  
      Project author: @Alexamig
        ‚Ä¢ GitHub: https://github.com/Alexamig
      </details>

  domain: automation

  input:

    debounce_no_motion:
      name: ‚è≥ –ó–∞–¥–µ—Ä–∂–∫–∞ –ü–ï–†–ï–î –¥–≤–∏–∂–µ–Ω–∏–µ–º
      default: 0
      selector:
        number:
          min: 0
          max: 10
          step: 1
          unit_of_measurement: —Å–µ–∫
      description: |
        –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è.
        ‚Ä¢ –°–æ–±—ã—Ç–∏–µ `motion_on` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏
        ‚Ä¢ –¥–∞—Ç—á–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `on` –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ
        ‚Ä¢ –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

    debounce_after_motion:
      name: ‚è≥ –ó–∞–¥–µ—Ä–∂–∫–∞ –ü–û–°–õ–ï –¥–≤–∏–∂–µ–Ω–∏—è
      default: 1
      selector:
        number:
          min: 0
          max: 30
          step: 1
          unit_of_measurement: —Å–µ–∫
      description: |
        –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è.
        ‚Ä¢ –°–æ–±—ã—Ç–∏–µ `motion_off` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏
        ‚Ä¢ –¥–∞—Ç—á–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `off` –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ
        ‚Ä¢ –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

    use_motion_sensor:
      name: üßç –†–µ–∞–∫—Ü–∏—è –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ
      default: true
      selector:
        boolean: {}
      description: |
        **‚úÖ –í–ö–õ:** –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ
        **‚ùå –í–´–ö–õ:** –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –ù–ï —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ, –ù–û:
        ‚Ä¢ –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        ‚Ä¢ –¢–∞–π–º–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
        ‚Ä¢ –ü—Ä–∏ —Å–º–µ–Ω–µ –¥–Ω—è/–Ω–æ—á–∏ —Å–≤–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ)

    motion_sensor:
      name: üèÉ –î–∞—Ç—á–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è
      selector:
        entity:
          domain: binary_sensor
      description: |
        –ë–∏–Ω–∞—Ä–Ω—ã–π —Å–µ–Ω—Å–æ—Ä **(`motion/occupancy`)**
        ‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –¥–∞—Ç—á–∏–∫.

    master_entity:
      name: –û—Å–Ω–æ–≤–Ω–æ–π (üí°Light/üéöÔ∏èSwitch)
      selector:
        entity:
          domain: [light, switch]
      description: |
        **–û—Å–Ω–æ–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ (`light` –∏–ª–∏ `switch`):**
        ‚Ä¢ –í–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é –∏–ª–∏ –≤—Ä—É—á–Ω—É—é.
        ‚Ä¢ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π —ç–ª–µ–º–µ–Ω—Ç.

    master_timer_helper:
      name: ‚è±Ô∏è –¢–∞–π–º–µ—Ä (Master)
      selector:
        entity:
          domain: timer
      description: |
        ‚Ä¢ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è
          –∏–ª–∏ —Ä—É—á–Ω–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è Master.
        ‚ö†Ô∏è **–û–±—è–∑–∞—Ç–µ–ª–µ–Ω –∫ –≤—ã–±–æ—Ä—É!**
        ‚Ä¢ –û—Ç–¥–µ–ª—å–Ω—ã–π entity —Ç–∏–ø–∞ timer.
        üí° **–°–û–í–ï–¢:** –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û –∫–∞–∫
         —Ç–∞–π–º–µ—Ä –¥–ª—è Slave ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –≤ –ø–æ–ª–µ ¬´‚è≤Ô∏è –¢–∞–π–º–µ—Ä Slave¬ª!

    master_time_off:
      name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ Master
      default:
        minutes: 2
      selector:
        duration: {}
      description: |
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Ç–∞–π–º–µ—Ä–∞ Master.
        ‚Ä¢ –û—Ç–¥–µ–ª—å–Ω—ã–π entity —Ç–∏–ø–∞ timer.

    sync_slave_group:
      name: üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
      default: false
      selector:
        boolean: {}
      description: |
        –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –≤—Å–µ –∫–∞–∫ –≥—Ä—É–ø–ø–∞.
        ‚Ä¢ –í—ã–∫–ª—é—á–µ–Ω–∏–µ –ø–æ Master –≤—ã–∫–ª—é—á–∞–µ—Ç –≤—Å–µ Slave.

    slave_entities:
      name: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (üí°Light/üñ≤Ô∏èSwitch)
      default: []
      selector:
        entity:
          domain: [light, switch]
          multiple: true
      description: |
        ‚Ä¢ **–ú–æ–≥—É—Ç –±—ã—Ç—å `light` –∏ `switch`, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å–º–µ—à–∞–Ω–Ω—ã–º–∏.**
        ‚Ä¢ ‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï:** –ù–µ –≤—ã–±–∏—Ä–∞–π—Ç–µ Master —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–¥–µ—Å—å
          –µ—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ –≤ –ø–æ–ª–µ ¬´–û—Å–Ω–æ–≤–Ω–æ–π Light/Switch¬ª
        ‚Ä¢ –†—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ Slave –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä Slave,  
          –µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞ –∏ —Ç–∞–π–º–µ—Ä –≤—ã–±—Ä–∞–Ω.
        –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä Master.
        ‚Ä¢ –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–æ–ø. —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

    slave_timer_helper:
      name: ‚è≤Ô∏è –¢–∞–π–º–µ—Ä (Slave)
      default: null
      selector:
        entity:
          domain: timer
      description: |
        ‚ö†Ô∏è **–û–±—è–∑–∞—Ç–µ–ª–µ–Ω** –≤ —Ä–µ–∂–∏–º–µ:
        ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞
        ‚Ä¢ –ï—Å—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ ¬´–î–æ–ø. Light / Switch¬ª
        ‚Ä¢ –û—Ç–¥–µ–ª—å–Ω—ã–π entity —Ç–∏–ø–∞ timer.
        üí° **–°–û–í–ï–¢:** –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –¢–û–¢ –ñ–ï —Ç–∞–π–º–µ—Ä, —á—Ç–æ –∏ –≤ Master!
        ‚Ä¢ –¢–æ–≥–¥–∞ –æ–¥–∏–Ω —Ç–∞–π–º–µ—Ä –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å Master –∏ Slave.

    slave_time_off:
      name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ Slave
      default:
        minutes: 2
      selector:
        duration: {}
      description: |
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã —Ç–∞–π–º–µ—Ä–∞ Slave.
        ‚Ä¢ ‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞.

    slave_ignore_day_night:
      name: üîï –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ (Slave)
      default: []
      selector:
        entity:
          domain: [light, switch]
          multiple: true
      description: |
        **üìå –í–ê–ñ–ù–û:**
        ‚Ä¢ ‚ö†Ô∏è –≠—Ç–∞ –æ–ø—Ü–∏—è **–ù–ï –†–ê–ë–û–¢–ê–ï–¢** –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π üîÑ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
        ‚Ä¢ –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Å–µ Slave —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω–∞—è –≥—Ä—É–ø–ø–∞ —á–µ—Ä–µ–∑ Master
        ‚Ä¢ –§—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ **üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è = –í–´–ö–õ**

        **üéØ –ü–û–í–ï–î–ï–ù–ò–ï:**
        ‚Ä¢ Slave –≤ —ç—Ç–æ–º —Å–ø–∏—Å–∫–µ –≤–∫–ª—é—á–∞—é—Ç—Å—è –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é –í–°–ï–ì–î–ê
        ‚Ä¢ –û—Å—Ç–∞–ª—å–Ω—ã–µ Slave —Å–ª–µ–¥—É—é—Ç –æ–±—â–µ–º—É —Ä–µ–∂–∏–º—É üåû–î–µ–Ω—å/üåú–ù–æ—á—å
        ‚Ä¢ –°–º–µ–Ω–∞ –¥–Ω—è/–Ω–æ—á–∏ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

    night_sensor:
      name: üåû–î–µ–Ω—å/üåú–ù–æ—á—å
      selector:
        entity:
          domain: binary_sensor
      description: |
        **–°–µ–Ω—Å–æ—Ä –¥–Ω—è/–Ω–æ—á–∏ (–ë–∏–Ω–∞—Ä–Ω—ã–π —Å–µ–Ω—Å–æ—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)**
        ‚Ä¢ –ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å **template** –∑–∞–≥–ª—É—à–∫—É. (**–ö–æ–¥ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏**)
        ‚Ä¢ ‚ö†Ô∏è –í–ª–∏—è–µ—Ç –Ω–∞ –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é.
        ‚Ä¢ üåû –î–µ–Ω—å (ON): –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é –∑–∞–ø—Ä–µ—â–µ–Ω–æ.
        ‚Ä¢ üåú –ù–æ—á—å (OFF): –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –ø–æ –¥–≤–∏–∂–µ–Ω–∏—é —Ä–∞–∑—Ä–µ—à–µ–Ω–æ.

    use_day_night:
      name: –†–µ–∂–∏–º (üîÜ–î–µ–Ω—å/üïØÔ∏è–ù–æ—á—å)
      default: false
      selector:
        boolean: {}
      description: |
        **‚ùå –í–´–ö–õ:** –í—Å–µ–≥–¥–∞ –ù–û–ß–¨ (–∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
        **‚úÖ –í–ö–õ:** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–∞—Ç—á–∏–∫–∞ üåû–î–µ–Ω—å/üåú–ù–æ—á—å:
        ‚Ä¢ –î–µ–Ω—å (ON) ‚Üí –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ
        ‚Ä¢ –ù–æ—á—å (OFF) ‚Üí –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
        –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ üßç –ü–æ –¥–≤–∏–∂–µ–Ω–∏—é = –í–´–ö–õ

    invert_night_sensor:
      name: üåó –ò–Ω–≤–µ—Ä—Å–∏—è ‚Üí (–¥–µ–Ω—å ‚Üî –Ω–æ—á—å)
      default: false
      selector:
        boolean: {}
      description: |
        **–ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É –î–µ–Ω—å/–ù–æ—á—å:**
        ‚Ä¢ **ON** ‚Üí –û–±—Ä–∞—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        ‚Ä¢ **OFF** ‚Üí –ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

variables:
  master_entity: !input master_entity
  slave_entities: !input slave_entities
  motion_sensor: !input motion_sensor
  master_timer_entity: !input master_timer_helper
  slave_timer_entity: !input slave_timer_helper
  master_time_off: !input master_time_off
  slave_time_off: !input slave_time_off
  debounce_no_motion: !input debounce_no_motion
  debounce_after_motion: !input debounce_after_motion
  sync_slave_group: !input sync_slave_group
  use_motion_sensor: !input use_motion_sensor
  use_day_night: !input use_day_night
  night_sensor: !input night_sensor
  invert_night_sensor: !input invert_night_sensor

  has_slaves: "{{ slave_entities | length > 0 }}"
  motion_ok: "{{ states(motion_sensor) not in ('unavailable','unknown') }}"

  night_is_active: >
    {% if not use_day_night %}
      true
    {% else %}
      {% set s = states(night_sensor) %}
      {% if s in ('unknown','unavailable') %}
        false
      {% else %}
        {% set night = s == 'off' %}
        {{ not night if invert_night_sensor else night }}
      {% endif %}
    {% endif %}
  
  auto_allowed: "{{ night_is_active }}"

  day_night_ready: >
    {{ not use_day_night
       or states(night_sensor) not in ('unknown','unavailable') }}

  # --- –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è Day/Night ---
  slave_ignore_day_night: !input slave_ignore_day_night

  # –°–ø–∏—Å–æ–∫ Slave, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç –Ω–∞ Day/Night
  slaves_day_night_active: >
    {% if has_slaves %}
      {% if sync_slave_group %}
        {{ slave_entities }}
      {% else %}
        {{ slave_entities | reject('in', slave_ignore_day_night) | list }}
      {% endif %}
    {% else %}
      []
    {% endif %}
  

mode: restart

trigger:
  - platform: state
    entity_id: !input motion_sensor
    to: "on"
    for:
      seconds: !input debounce_no_motion
    id: motion_on

  - platform: state
    entity_id: !input motion_sensor
    to: "off"
    for:
      seconds: !input debounce_after_motion
    id: motion_off

  - platform: state
    entity_id: !input motion_sensor
    to: ["unavailable","unknown"]
    id: motion_unavailable

  - platform: event
    event_type: timer.finished
    id: timer_finished

  - platform: state
    entity_id: !input master_entity
    id: master_changed

  - platform: state
    entity_id: !input slave_entities
    id: slave_changed

  - platform: time_pattern
    minutes: "/5"
    id: safety_check

  - platform: state
    entity_id: !input night_sensor
    id: night_sensor_changed

action:
  # ‚ùó –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  - choose:
      # 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Master –≤ Slave
      - conditions: "{{ master_entity in slave_entities }}"
        sequence:
          - variables:
              notif_id: "master_slave_conflict_{{ master_entity|replace('.', '_') }}"
          - service: persistent_notification.create
            data:
              title: "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤: Master –≤ Slave"
              message: "üö® –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ `{{ master_entity }}` –≤—ã–±—Ä–∞–Ω–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∫–∞–∫ Master –∏ Slave"
              notification_id: "{{ notif_id }}"
          - stop: "Master cannot be Slave"
      
      # 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–∞ Slave
      - conditions: >
          {{ has_slaves 
             and slave_timer_entity is none 
             and not (sync_slave_group and master_timer_entity is not none) }}
        sequence:
          - variables:
              notif_id: "missing_slave_timer_{{ master_entity|replace('.', '_') }}"
          - service: persistent_notification.create
            data:
              title: "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Slave"
              message: |
                üö® **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** {{ '–í–∫–ª—é—á–µ–Ω–∞' if sync_slave_group else '–í—ã–∫–ª—é—á–µ–Ω–∞' }}
                ‚ö†Ô∏è **–¢–∞–π–º–µ—Ä Slave:** –ù–µ –≤—ã–±—Ä–∞–Ω
              notification_id: "{{ notif_id }}"
          - stop: "Missing Slave timer"
      
      # 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Master –≤ slave_ignore_day_night
      - conditions: "{{ master_entity in slave_ignore_day_night }}"
        sequence:
          - variables:
              notif_id: "master_ignore_conflict_{{ master_entity|replace('.', '_') }}"
          - service: persistent_notification.create
            data:
              title: "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç: Master –≤ —Å–ø–∏—Å–∫–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è"
              message: |
                üö® **–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:** `{{ master_entity }}`
                
                ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** Master –≤—ã–±—Ä–∞–Ω –≤ —Å–ø–∏—Å–∫–µ:
                ¬´–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ (Slave)¬ª
                
                **üìå –ü–æ—á–µ–º—É —ç—Ç–æ –æ—à–∏–±–∫–∞:**
                ‚Ä¢ Master –≤—Å–µ–≥–¥–∞ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—â–∏–º —Ä–µ–∂–∏–º–æ–º –¥–Ω—è/–Ω–æ—á–∏
                ‚Ä¢ –û–ø—Ü–∏—è `slave_ignore_day_night` —Ä–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ –¥–ª—è Slave**
                
                **‚úÖ –†–µ—à–µ–Ω–∏–µ:**
                –£–¥–∞–ª–∏—Ç—å `{{ master_entity }}` –∏–∑ —Å–ø–∏—Å–∫–∞:
                ¬´–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è —Å—É—Ç–æ–∫ (Slave)¬ª
              notification_id: "{{ notif_id }}"
          - stop: "Master cannot be in slave_ignore_day_night"


  - variables:
      slaves_list: >-
        {% if has_slaves %}
          {% set ns = namespace(list=[]) %}
          {% for entity in slave_entities %}
            {% set ns.list = ns.list + [entity] %}
          {% endfor %}
          {{ ns.list }}
        {% else %}
          []
        {% endif %}

      slaves_on_now: >-
        {% if has_slaves %}
          {{ expand(slaves_list) 
             | selectattr('state', 'in', ['on', 'true'])
             | map(attribute='entity_id')
             | list }}
        {% else %}
          []
        {% endif %}
      
      slaves_empty: "{{ slaves_on_now | length == 0 }}"
      slaves_count: "{{ slaves_on_now | length }}"
      motion_state: "{{ states(motion_sensor) }}"
      timer_state: "{{ states(master_timer_entity) }}"
      slave_timer_state: "{{ states(slave_timer_entity) if slave_timer_entity else 'idle' }}"
      master_state: "{{ states(master_entity) }}"
      same_timer: "{{ master_timer_entity == slave_timer_entity }}"


  # üîÑ –ë–õ–û–ö–ò choose
  - choose:

      # 1Ô∏è‚É£ Motion ON
      - conditions: "{{ trigger.id == 'motion_on' }}"
        sequence:
          - if: "{{ timer_state != 'idle' }}"
            then:
              - service: timer.cancel
                target: { entity_id: !input master_timer_helper }
          
          - if: "{{ has_slaves and slave_timer_entity and slave_timer_state != 'idle' }}"
            then:
              - service: timer.cancel
                target: { entity_id: !input slave_timer_helper }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ
          - if: "{{ not use_motion_sensor }}"
            then:
              - stop: "Motion disabled"
          
          - if: "{{ use_day_night and not day_night_ready }}"
            then:
              - stop: "Day/Night sensor not ready"
          
          # –í–∫–ª—é—á–∞–µ–º Master –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –Ω–æ—á—å—é/–¥–Ω—ë–º
          - if: "{{ night_is_active and motion_state == 'on' and master_state == 'off' }}"
            then:
              - service: homeassistant.turn_on
                target: { entity_id: !input master_entity }
          
          # –í–∫–ª—é—á–∞–µ–º Slave –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –Ω–æ—á—å—é/–¥–Ω—ë–º
          - if: >
              {{ night_is_active
                 and sync_slave_group
                 and has_slaves
                 and slaves_empty
                 and motion_state == 'on' }}
            then:
              - service: homeassistant.turn_on
                target: { entity_id: "{{ slaves_list }}" }

      # 2Ô∏è‚É£ Motion OFF
      - conditions: "{{ trigger.id == 'motion_off' }}"
        sequence:
          - variables:
              current_motion: "{{ states(motion_sensor) }}"
              master_state: "{{ states(master_entity) }}"
              slaves_on_now: >-
                {% if has_slaves %}
                  {% set ns = namespace(list=[]) %}
                  {% for entity in slaves_list %}
                    {% if states(entity) in ['on', 'true'] %}
                      {% set ns.list = ns.list + [entity] %}
                    {% endif %}
                  {% endfor %}
                  {{ ns.list }}
                {% else %}
                  []
                {% endif %}
              slaves_count: "{{ slaves_on_now | length }}"
              any_on: "{{ master_state == 'on' or slaves_count > 0 }}"
              timer_state: "{{ states(master_timer_entity) }}"
              slave_timer_state: "{{ states(slave_timer_entity) if slave_timer_entity else 'idle' }}"
          
          - if: "{{ current_motion == 'off' }}"
            then:
              - choose:
                  - conditions: "{{ same_timer }}"
                    sequence:
                      - if: "{{ any_on and timer_state == 'idle' }}"
                        then:
                          - service: timer.start
                            target: { entity_id: !input master_timer_helper }
                            data: { duration: "{{ master_time_off }}" }
                  
                  - conditions: "{{ not same_timer }}"
                    sequence:
                      - if: "{{ master_state == 'on' and timer_state == 'idle' }}"
                        then:
                          - service: timer.start
                            target: { entity_id: !input master_timer_helper }
                            data: { duration: "{{ master_time_off }}" }
                      
                      - if: >
                          {{ not sync_slave_group
                             and slaves_count > 0
                             and slave_timer_state == 'idle' }}
                        then:
                          - service: timer.start
                            target: { entity_id: !input slave_timer_helper }
                            data: { duration: "{{ slave_time_off }}" }

      # 3Ô∏è‚É£ Night Sensor Changed
      - conditions: "{{ trigger.id == 'night_sensor_changed' }}"
        sequence:
          - if: "{{ not use_day_night or trigger.from_state is none }}"
            then:
              - stop: "Day/Night change ignored"
      
          - variables:
              motion_state: "{{ states(motion_sensor) }}"
              master_state: "{{ states(master_entity) }}"
              slaves_on_now: >
                {% if has_slaves %}
                  {{ expand(slaves_list)
                     | selectattr('state','in',['on','true'])
                     | map(attribute='entity_id')
                     | list }}
                {% else %}
                  []
                {% endif %}
              slaves_empty: "{{ slaves_on_now | length == 0 }}"
      
          - if: "{{ night_is_active and motion_state == 'on' and master_state == 'off' }}"
            then:
              - service: homeassistant.turn_on
                target: { entity_id: !input master_entity }

          - if: >
              {{ night_is_active
                 and motion_state == 'on'
                 and sync_slave_group
                 and slaves_day_night_active | length > 0 }}
            then:
              - service: homeassistant.turn_on
                target: { entity_id: "{{ slaves_day_night_active }}" }
          
          - if: "{{ not night_is_active }}"
            then:
              - service: homeassistant.turn_off
                target: { entity_id: !input master_entity }
          
              - if: "{{ slaves_day_night_active | length > 0 }}"
                then:
                  - service: homeassistant.turn_off
                    target: { entity_id: "{{ slaves_day_night_active }}" }

      # 4Ô∏è‚É£ Motion unavailable
      - conditions: "{{ trigger.id == 'motion_unavailable' }}"
        sequence:
          - choose:
              - conditions: "{{ sync_slave_group and has_slaves and slaves_on_now|length > 0 }}"
                sequence:
                  - if: "{{ timer_state == 'idle' }}"
                    then:
                      - service: timer.start
                        target: { entity_id: !input master_timer_helper }
                        data: { duration: "{{ master_time_off }}" }
              
              - conditions: "{{ not sync_slave_group }}"
                sequence:
                  - if: "{{ master_state == 'on' and timer_state == 'idle' }}"
                    then:
                      - service: timer.start
                        target: { entity_id: !input master_timer_helper }
                        data: { duration: "{{ master_time_off }}" }
                  
                  - if: >
                      {{ has_slaves 
                         and slave_timer_entity
                         and slaves_on_now|length > 0
                         and slave_timer_state == 'idle' }}
                    then:
                      - service: timer.start
                        target: { entity_id: !input slave_timer_helper }
                        data: { duration: "{{ slave_time_off }}" }

      # 5Ô∏è‚É£ Master changed
      - conditions: "{{ trigger.id == 'master_changed' }}"
        sequence:
          - variables:
              master_state: "{{ trigger.to_state.state }}"
              manual: "{{ trigger.to_state.context.user_id is not none }}"
              current_motion: "{{ states(motion_sensor) }}"
              slaves_on_now: >-
                {% if has_slaves %}
                  {{ expand(slaves_list)
                     | selectattr('state', 'in', ['on', 'true'])
                     | map(attribute='entity_id')
                     | list }}
                {% else %}
                  []
                {% endif %}
              slaves_empty: "{{ slaves_on_now | length == 0 }}"
              slaves_count: "{{ slaves_on_now | length }}"
              timer_state: "{{ states(master_timer_entity) }}"
              slave_timer_state: "{{ states(slave_timer_entity) if slave_timer_entity else 'idle' }}"
          
          - if: "{{ master_state == 'on' }}"
            then:
              - if: "{{ sync_slave_group and has_slaves and slaves_empty }}"
                then:
                  - service: homeassistant.turn_on
                    target: { entity_id: "{{ slaves_list }}" }
              
              - if: "{{ current_motion == 'off' and timer_state == 'idle' }}"
                then:
                  - service: timer.start
                    target: { entity_id: !input master_timer_helper }
                    data: { duration: "{{ master_time_off }}" }
          
          - if: "{{ master_state == 'off' and manual }}"
            then:
              - service: timer.cancel
                target: { entity_id: !input master_timer_helper }
              
              - if: "{{ sync_slave_group and has_slaves }}"
                then:
                  - service: homeassistant.turn_off
                    target: { entity_id: "{{ slaves_list }}" }
              
              - if: "{{ not same_timer and has_slaves and slaves_count > 0 and current_motion == 'off' }}"
                then:
                  - if: "{{ slave_timer_state == 'idle' }}"
                    then:
                      - service: timer.start
                        target: { entity_id: !input slave_timer_helper }
                        data: { duration: "{{ slave_time_off }}" }
                  
                  - if: "{{ timer_state == 'idle' and current_motion == 'off' }}"
                    then:
                      - service: timer.start
                        target: { entity_id: !input master_timer_helper }
                        data: { duration: "{{ master_time_off }}" }
              
              - if: "{{ same_timer and has_slaves and slaves_count > 0 and current_motion == 'off' and timer_state == 'idle' }}"
                then:
                  - service: timer.start
                    target: { entity_id: !input master_timer_helper }
                    data: { duration: "{{ master_time_off }}" }

      # 6Ô∏è‚É£ Slave changed
      - conditions: "{{ trigger.id == 'slave_changed' }}"
        sequence:
          - variables:
              state: "{{ trigger.to_state.state }}"
              slaves_on_now: >-
                {% if has_slaves %}
                  {{ expand(slaves_list)
                     | selectattr('state', 'in', ['on', 'true'])
                     | map(attribute='entity_id')
                     | list }}
                {% else %}
                  []
                {% endif %}
              slaves_empty: "{{ slaves_on_now | length == 0 }}"
              slaves_count: "{{ slaves_on_now | length }}"
              master_state: "{{ states(master_entity) }}"
              current_motion: "{{ states(motion_sensor) }}"
              timer_state: "{{ states(master_timer_entity) }}"
              slave_timer_state: "{{ states(slave_timer_entity) if slave_timer_entity else 'idle' }}"
          
          - if: "{{ state in ['on', 'true'] }}"
            then:
              - if: "{{ sync_slave_group and master_state == 'off' }}"
                then:
                  - service: homeassistant.turn_on
                    target: { entity_id: !input master_entity }
              
              - if: "{{ sync_slave_group and has_slaves }}"
                then:
                  - variables:
                      other_slaves: "{{ slaves_list | reject('equalto', trigger.entity_id) | list }}"
                  - if: "{{ other_slaves | length > 0 }}"
                    then:
                      - service: homeassistant.turn_on
                        target: { entity_id: "{{ other_slaves }}" }
              
              - if: "{{ current_motion == 'off' }}"
                then:
                  - choose:
                      - conditions: "{{ not same_timer and not sync_slave_group }}"
                        sequence:
                          - if: "{{ slave_timer_state == 'idle' }}"
                            then:
                              - service: timer.start
                                target: { entity_id: !input slave_timer_helper }
                                data: { duration: "{{ slave_time_off }}" }
                      - conditions: "{{ same_timer }}"
                        sequence:
                          - if: "{{ timer_state == 'idle' }}"
                            then:
                              - service: timer.start
                                target: { entity_id: !input master_timer_helper }
                                data: { duration: "{{ master_time_off }}" }
          
          - if: "{{ state in ['off', 'false'] }}"
            then:
              - if: "{{ master_state == 'off' and slaves_empty and current_motion == 'off' }}"
                then:
                  - if: "{{ timer_state == 'active' }}"
                    then:
                      - service: timer.cancel
                        target: { entity_id: !input master_timer_helper }
                  
                  - if: "{{ not same_timer and not sync_slave_group and slave_timer_state == 'active' }}"
                    then:
                      - service: timer.cancel
                        target: { entity_id: !input slave_timer_helper }

      # 7Ô∏è‚É£ Master timer finished
      - conditions: >
          {{ trigger.id == 'timer_finished' 
             and trigger.event.data.entity_id == master_timer_entity }}
        sequence:
          - variables:
              slaves_on_now: >-
                {% if has_slaves %}
                  {{ expand(slaves_list)
                     | selectattr('state', 'in', ['on', 'true'])
                     | map(attribute='entity_id')
                     | list }}
                {% else %}
                  []
                {% endif %}
              entities_to_off: >-
                {% set list = [master_entity] %}
                {% if has_slaves and (sync_slave_group or same_timer) %}
                  {% set list = list + slaves_on_now %}
                {% endif %}
                {{ list }}
          
          - service: homeassistant.turn_off
            target: { entity_id: "{{ entities_to_off }}" }
      
      # 8Ô∏è‚É£ Slave timer finished
      - conditions: >
          {{ trigger.id == 'timer_finished' 
             and master_timer_entity != slave_timer_entity
             and trigger.event.data.entity_id == slave_timer_entity }}
        sequence:
          - variables:
              slaves_on_now: >-
                {% if has_slaves %}
                  {{ expand(slaves_list)
                     | selectattr('state', 'in', ['on', 'true'])
                     | map(attribute='entity_id')
                     | list }}
                {% else %}
                  []
                {% endif %}
          
          - service: homeassistant.turn_off
            target: { entity_id: "{{ slaves_on_now }}" }

      # 9Ô∏è‚É£ Safety check (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
      - conditions: "{{ trigger.id == 'safety_check' }}"
        sequence:
          - variables:
              motion_state: "{{ states(motion_sensor) }}"
              master_state: "{{ states(master_entity) }}"
              timer_state: "{{ states(master_timer_entity) }}"
              slave_timer_state: "{{ states(slave_timer_entity) if slave_timer_entity else 'idle' }}"
              same_timer: "{{ master_timer_entity == slave_timer_entity }}"
              
              slaves_on_now: >
                {% if has_slaves %}
                  {{ expand(slaves_list)
                     | selectattr('state', 'in', ['on', 'true'])
                     | map(attribute='entity_id')
                     | list }}
                {% else %}
                  []
                {% endif %}
              slaves_count: "{{ slaves_on_now | length }}"
              any_on: "{{ master_state == 'on' or slaves_count > 0 }}"
          
          - if: "{{ motion_state in ('unavailable', 'unknown') }}"
            then:
              - choose:
                  - conditions: "{{ any_on }}"
                    sequence:
                      - choose:
                          - conditions: "{{ same_timer }}"
                            sequence:
                              - if: "{{ timer_state == 'idle' }}"
                                then:
                                  - service: timer.start
                                    target: { entity_id: !input master_timer_helper }
                                    data: { duration: "{{ master_time_off }}" }
                          
                          - conditions: "{{ not same_timer }}"
                            sequence:
                              - if: "{{ master_state == 'on' and timer_state == 'idle' }}"
                                then:
                                  - service: timer.start
                                    target: { entity_id: !input master_timer_helper }
                                    data: { duration: "{{ master_time_off }}" }
                              
                              - if: >
                                  {{ not sync_slave_group
                                     and slaves_count > 0
                                     and slave_timer_state == 'idle' }}
                                then:
                                  - service: timer.start
                                    target: { entity_id: !input slave_timer_helper }
                                    data: { duration: "{{ slave_time_off }}" }








# Light/Switch Master-Slave Blueprint v5.0 FINAL STABLE

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/hacs/integration)
![GitHub release](https://img.shields.io/github/v/release/Alexamig/Light-Switch-Master-Slave-blueprint)

**✔ Production-ready Master/Slave automation blueprint**

**✔ Status: FINAL STABLE (frozen architecture)**

Универсальный blueprint для управления `light` и `switch` с полной fail-safe защитой на основе датчика движения и таймера.

---

## 📌 СОДЕРЖАНИЕ

- [Основная логика](#-основная-логика)
- [Возможности](#-возможности)
- [Поля ввода](#-поля-ввода)
- [Таблицы поведения](#-таблицы-поведения)
- [Установка](#-установка)
- [Требования](#-требования)
- [Автор](#-автор)
- [Лицензия](#-лицензия)

---

## ⭐ ОСНОВНАЯ ЛОГИКА

<details>
<summary>🔽 Развернуть полное описание</summary>

### 1️⃣ ⏱️ **ЗАДЕРЖКИ ПО ДВИЖЕНИЮ**

**⏳ Задержка ДО движения:**
• Задержка подтверждения появления движения.
• Событие `motion_on` обрабатывается только если
• датчик находится в состоянии `on` непрерывно
• в течение заданного времени.
• Защита от ложных срабатываний при кратковременных сигналах.

**⏳ Задержка ПОСЛЕ движения:**
• Задержка подтверждения окончания движения.
• Событие `motion_off` обрабатывается с задержкой,
• и таймеры запускаются только после её окончания.
• Позволяет свету не гаснуть при кратковременном отсутствии движения.

### 2️⃣ **Master:**
• Автоматически включается по движению, если:
  – **🧍 По движению** = ВКЛ (разрешено авто-включение)
  – **🌜 Режим Ночь** активен (или **🔆 Режим День/Ночь** выключен)
• При пропаже движения запускает таймер Master,
  если Master находится во включённом состоянии.
• Ручное включение Master при отсутствии движения
  ВСЕГДА запускает таймер Master.
• Ручное выключение Master:
    – останавливает таймер Master;
    – при включённой синхронизации выключает все Slave.
• ⚡ **Авто-включение по движению:**
    – Master включается автоматически
    – **Slave включаются автоматически ТОЛЬКО если:**
      * включена синхронизация 🔄
      * все Slave выключены
      * разрешён режим Night/Day
      * **🧍 По движению** = ВКЛ

### 3️⃣ **Slave:**
• Таймер Slave является групповым:
  один таймер управляет всеми Slave одновременно.
• При включении Slave (при активной синхронизации)
  автоматически включает Master, если он был выключен.
• При ручном включении Slave без движения
  запускается таймер Slave (только если синхронизация отключена).
• При включённой синхронизации:
    – включаются **все** остальные Slave, кроме инициировавшего событие
    – таймер Slave не используется (работает только таймер Master)
• Ручное выключение Slave:
    – не выключает Master;
    – если Master выключен и все Slave выключены,
      активный таймер останавливается.
• Таймер Slave реагирует на появление движения:
  при обнаружении движения таймер отменяется.

### 4️⃣ **Таймер:**
• Таймеры Master и Slave запускаются только если они в состоянии idle (не активны).
• Останавливаются при появлении движения или при ручном выключении устройств.
• Таймер Master выключает Master и **все включённые Slave** (при синхронизации или общем таймере).
• Таймер Slave является общим для всех Slave и выключает ВСЕ включённые Slave одновременно.
• ⚠️ Работают ВСЕГДА, независимо от дня/ночи!

### 5️⃣ **День / Ночь (опционально):**
| Режим | Движение | Авто-включение | Действие |
|-------|---------|----------------|----------|
| 🌞 День | Есть | ❌ Запрещено | Свет не включается |
| 🌞 День | Нет | ❌ Запрещено | - |
| 🌜 Ночь | Есть | ✅ Разрешено | Свет включается |
| 🌜 Ночь | Нет | ✅ Разрешено | - |

**🔄 Смена режима:**
• День → Ночь, движение есть → **свет ВКЛЮЧАЕТСЯ** ✅
• Ночь → День, движение есть → **свет ВЫКЛЮЧАЕТСЯ** ✅
• Ночь → День, движения нет → **свет ВЫКЛЮЧАЕТСЯ** ✅

**🔧 Пример заглушки для night_sensor:**
```yaml
template:
  - binary_sensor:
      - name: "Night Always"
        unique_id: night_always
        state: "{{ false }}"
        availability: "{{ true }}"
• state: "{{ false }}" - Всегда Ночь (OFF) ✅ авто-включение разрешено
• state: "{{ true }}" - Всегда День (ON) ❌ авто-включение запрещено

6️⃣ Fail-safe (аварийная защита):
• Если датчик движения становится unavailable или unknown,
и при этом Master или любой Slave остаётся включён,
запускается соответствующий таймер.
• Дополнительная периодическая проверка каждые 5 минут.

7️⃣ Особенности:
• Поддержка любого количества Slave-устройств.
• Slave могут быть смешанных доменов (light и switch).
• Две независимые задержки: для включения (debounce_no_motion) и для выключения (debounce_after_motion).
• Все сервисные вызовы выполняются только при наличии целевых entity.

8️⃣ 💡 ГИБКОСТЬ ТАЙМЕРОВ:
• Один таймер для Master и Slave — выберите ОДИН И ТОТ ЖЕ timer helper в обоих полях!
• ✅ Master таймер выключит Master и Slave (при синхронизации)
• ✅ Slave таймер выключит только Slave
• ⚡ Работает даже без синхронизации!
• 🔧 Просто укажите один entity в:
– ⏱️ Таймер Master
– ⏲️ Таймер Slave

9️⃣ 🔌 УПРАВЛЕНИЕ РЕЖИМАМИ:
Взаимодействие 🧍 По движению и 🔆 Режим День/Ночь:

🧍 По движению	🔆 Режим День/Ночь	Движение	Результат
✅ ВКЛ	❌ ВЫКЛ	Есть	✅ Свет включается всегда
✅ ВКЛ	❌ ВЫКЛ	Нет	❌ Таймер запускается
✅ ВКЛ	✅ ВКЛ (День)	Есть	❌ Свет НЕ включается
✅ ВКЛ	✅ ВКЛ (Ночь)	Есть	✅ Свет включается
❌ ВЫКЛ	Любой	Есть	❌ Свет НЕ включается
❌ ВЫКЛ	Любой	Нет	❌ Только таймеры от ручного вкл
Важно:
• 🧍 По движению = ВЫКЛ полностью отключает автоматику,
но ручное управление и таймеры работают как обычно
• При смене День/Ночь свет синхронизируется с движением
(даже если 🧍 По движению = ВЫКЛ)

🔟 🔕 ИГНОРИРОВАНИЕ ВРЕМЕНИ СУТОК ДЛЯ SLAVE:
Функция позволяет отдельным Slave работать независимо от дня/ночи.

Ситуация	🔄 Синхронизация	🔕 Игнорирование	Результат
Slave в списке	❌ ВЫКЛ	✅ В списке	Работает всегда
Slave НЕ в списке	❌ ВЫКЛ	❌ Вне списка	Следует день/ночь
Любой Slave	✅ ВКЛ	Любое	❌ НЕ РАБОТАЕТ (все как группа)
📌 ВАЖНО: Опция доступна только при 🔄 Синхронизация = ВЫКЛ

</details>
✨ ВОЗМОЖНОСТИ
Функция	Описание
⏱️ Две задержки движения	Отдельные задержки на включение и выключение
🎚️ Master/Slave архитектура	Один Master + неограниченное число Slave
🔄 Гибкие режимы синхронизации	Групповой или независимый режим
⏲️ Гибкость таймеров	Раздельные или один общий таймер
🌞🌜 Режим День/Ночь	Авто-включение только ночью (с инверсией)
🔕 Игнорирование дня/ночи	Выборочные Slave работают всегда
🛡️ Fail-safe защита	Авто-таймеры при недоступном датчике
🔧 Тройная проверка конфига	Master в Slave, таймеры, Master в ignore
📋 ПОЛЯ ВВОДА
Поле	Обязательное	Описание
debounce_no_motion	✓	Задержка перед движением (0-10 сек)
debounce_after_motion	✓	Задержка после движения (0-30 сек)
use_motion_sensor	✓	Вкл/выкл реакцию на движение
motion_sensor	✓	Датчик движения
master_entity	✓	Основное устройство
master_timer_helper	✓	Таймер для Master
master_time_off	✓	Длительность таймера Master
sync_slave_group	✓	Режим синхронизации
slave_entities	-	Дополнительные устройства
slave_timer_helper	-	Таймер для Slave
slave_time_off	-	Длительность таймера Slave
slave_ignore_day_night	-	Slave, игнорирующие день/ночь
night_sensor	✓	Сенсор дня/ночи
use_day_night	✓	Включить режим день/ночь
invert_night_sensor	✓	Инверсия день/ночь
📊 ТАБЛИЦЫ ПОВЕДЕНИЯ
Режим День/Ночь
Режим	Движение	Авто-включение	Действие
🌞 День	Есть	❌ Запрещено	Свет не включается
🌞 День	Нет	❌ Запрещено	-
🌜 Ночь	Есть	✅ Разрешено	Свет включается
🌜 Ночь	Нет	✅ Разрешено	-
Взаимодействие режимов
🧍 По движению	🔆 День/Ночь	Движение	Результат
✅ ВКЛ	❌ ВЫКЛ	Есть	✅ Свет ВКЛ
✅ ВКЛ	❌ ВЫКЛ	Нет	❌ Таймер
✅ ВКЛ	✅ День	Есть	❌ Свет ВЫКЛ
✅ ВКЛ	✅ Ночь	Есть	✅ Свет ВКЛ
❌ ВЫКЛ	Любой	Есть	❌ Свет ВЫКЛ
❌ ВЫКЛ	Любой	Нет	❌ Только ручное
Игнорирование дня/ночи для Slave
Ситуация	🔄 Синхр.	🔕 Игнор.	Результат
Slave в списке	❌ ВЫКЛ	✅ В списке	Работает всегда
Slave НЕ в списке	❌ ВЫКЛ	❌ Вне списка	Следует день/ночь
Любой Slave	✅ ВКЛ	Любое	❌ НЕ РАБОТАЕТ
🚀 УСТАНОВКА
Через HACS (рекомендуется)
Добавьте этот репозиторий в HACS:

HACS → Интеграции → 3 точки → Пользовательские репозитории

URL: https://github.com/ВАШ_ЛОГИН/Light-Switch-Master-Slave-blueprint

Категория: Blueprint

Найдите "Light/Switch Master-Slave" в HACS и установите

Ручная установка
Скопируйте blueprint.yaml в папку blueprints/automation/ вашего Home Assistant

В HA перейдите Настройки → Автоматизации → Blueprints

Нажмите Импортировать blueprint и выберите файл

📌 ТРЕБОВАНИЯ
Home Assistant 2023.6 или новее

Датчик движения (binary_sensor)

Один или несколько timer helper'ов

Сенсор дня/ночи (можно создать заглушку через template)

